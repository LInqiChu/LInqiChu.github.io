---
title: "My_Plotly_dashboard"
output:
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: fill
    theme: darkly
---

```{r setup, include=FALSE}
library(tidyverse)
library(flexdashboard)
library(plotly)
library(p8105.datasets)
```


```{r}
# Import data
data("instacart")
```

```{r}
# Preprocess the dataset
instacart_df = 
  instacart |>
  janitor::clean_names() |> 
  
  # handle missing values
  mutate(
    across(where(is.character), ~na_if(., ".")),
    across(where(is.character), ~na_if(., "NA")),
    across(where(is.character), ~na_if(., ""))
    ) |>
  
  # create derived variables
  mutate(
    # order time categories
    order_hour_category = case_when(
      order_hour_of_day >= 6 & order_hour_of_day < 12 ~ "Morning (6-12)",
      order_hour_of_day >= 12 & order_hour_of_day < 18 ~ "Afternoon (12-18)",
      order_hour_of_day >= 18 & order_hour_of_day < 22 ~ "Evening (18-22)",
      TRUE ~ "Night (22-6)"
    ),
    # Day of week names
    order_day_name = case_when(
      order_dow == 0 ~ "Sunday",
      order_dow == 1 ~ "Monday",
      order_dow == 2 ~ "Tuesday",
      order_dow == 3 ~ "Wednesday",
      order_dow == 4 ~ "Thursday",
      order_dow == 5 ~ "Friday",
      order_dow == 6 ~ "Saturday"
    ),
    # Weekend indicator
    is_weekend = if_else(order_dow %in% c(0, 6), "Weekend", "Weekday"),
    # Simplified department categories
    dept_category = case_when(
      department %in% c("produce", "dairy eggs") ~ "Fresh Foods",
      department %in% c("snacks", "frozen", "ice cream ice") ~ "Snacks & Frozen",
      department %in% c("bakery", "deli", "meat seafood") ~ "Bakery & Deli",
      department %in% c("beverages", "alcohol") ~ "Beverages",
      department %in% c("pantry", "dry goods pasta", "canned goods") ~ "Pantry Staples",
      TRUE ~ "Other"
    ),
    # change reorder type
    is_reordered = as.logical(reordered)
  ) |>
  
    select(
    # IDs
    order_id, product_id, user_id,
    # Product information
    product_name, aisle, department, dept_category,
    # Order timing
    order_hour_of_day, order_hour_category,
    order_dow, order_day_name, is_weekend,
    # Order characteristics
    order_number, add_to_cart_order,
    days_since_prior_order,
    # Reorder behavior
    reordered, is_reordered
  )
```


Column {data-width=650}
-----------------------------------------------------------------------



条形图 (Bar Plot)

最受欢迎的产品: Top20最常购买的商品
最受欢迎的通道(aisle)或部门:按订单数量排序

散点图 (Scatter Plot)

订购时间 vs部门:X轴为订购小时，Y轴为部门，点的大小表示订单数量
订购时间 vs重新订购率:探索一天中不同时间段的重新订购行为



折线图 (Line Plot)

一天24小时的订单趋势: 展示购物高峰时段
一周七天的订单模式: 周一到周日的变化



### Top 20 Most Popular Products

```{r}
top20_products =
  instacart_df |>
  count(product_name, sort = TRUE) |>
  slice_head(n = 20) |>
  mutate(
     product_name = fct_reorder(product_name, n)
     ) |>
  plot_ly(x = ~n, y = ~product_name, type = "bar", colors = "viridis")

```







Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{r}

```

### Chart C

```{r}

```





















```{r}






```

## load the AirBnB dataset

```{r}
data(nyc_airbnb)

nyc_airbnb = 
  nyc_airbnb |> 
  mutate(rating = review_scores_location / 2) |>
  select(
    neighbourhood_group, neighbourhood, rating, price, room_type, lat, long) |>
  filter(
    !is.na(rating), 
    neighbourhood_group == "Manhattan",
    room_type == "Entire home/apt",
    price %in% 100:500)

```

## make a scatterplot

```{r}
nyc_airbnb = 
  nyc_airbnb |>
  mutate(text_label = str_c("Price: $", price, "\nRating: ", rating)) |> 
  plot_ly(
    x = ~lat, y = ~long, type = "scatter", mode = "markers",
    color = ~price, text = ~text_label, alpha = 0.5)

```


# make a boxplot

```{r}
nyc_airbnb |> 
  mutate(
    neighbourhood = fct_reorder(neighbourhood, price)
  ) |>
  plot_ly(
    x = ~neighbourhood, y = ~price, color = ~neighbourhood, 
    type = "box", colors = "viridis")


```

```{r}
nyc_airbnb |> 
  count(neighbourhood) |> 
  mutate(
    neighbourhood = fct_reorder(neighbourhood, n)) |> 
  plot_ly(x = ~neighbourhood, y = ~n, color = ~neighbourhood, type = "bar", colors = "viridis")

```

# ggplotly

```{r}
scatter_ggplot = 
  nyc_airbnb |>
  ggplot(aes(x = lat, y = long, color = price)) +
  geom_point(alpha = 0.25) +
  coord_cartesian()

ggplotly(scatter_ggplot)

```










## 



```{r}






```

## 




```{r}










```











